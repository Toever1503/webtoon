<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout.html}">
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Document</title>
    <link href="../static/main.css" rel="stylesheet"/>
</head>

<body>
<div class="max-w-[1100px] mx-auto p-[15px] bg-white" layout:fragment="content">
    <div class="breadcrumb py-[10px]">
        <nav class="w-full rounded-md">
            <ol class="list-reset flex">
                <li><a href="/"
                       class="text-sm text-blue-400 transition duration-150 ease-in-out hover:text-blue-600 focus:text-blue-600 active:text-blue-700 dark:text-blue-400 dark:hover:text-blue-500 dark:focus:text-blue-500 dark:active:text-blue-600">Trang
                    chủ</a>
                </li>
                <li><span class="mx-2 text-neutral-500 dark:text-neutral-400">/</span>
                </li>
                <li><a
                       class="text-sm text-primary transition duration-150 ease-in-out text-neutral-500 dark:text-neutral-400">Danh sách truyện</a>
                </li>
            </ol>
        </nav>
    </div>

    <div class="flex justify-between">
        <div class="p-4">
            <div class="flex justify-center">
                <div class="w-full">
                    <h2 th:if="${mangalist == null}">Không có dữ liệu!</h2>
                    <ul th:else class="manga-list grid grid-cols-4 items-center p-[0px] gap-x-[15px] gap-y-[25px] mt-[20px]">

                        <li class="w-[170px] bg-white relative box-shadow drop-shadow" style="1px 1px #bfbbbb38;" th:each="manga : ${mangalist}">
                            <a th:href="@{'/manga/'+${manga.mangaName}+'/'+${manga.id}}">
                                <img class="w-full h-[200px] hover:scale-[1.05] ease-in-out duration-200"
                                     th:src="${manga.featuredImage}"/>
                                <div class="manga-info block m-0 py-[10px] px-[5px]">
                                    <h4 class="font-bold leading-0 m-0">
                                        <a th:text="${manga.title.length() > 20 ? manga.title.substring(0, 12) + '...' : manga.title}"
                                           th:href="@{'/manga/'+${manga.title}+'/'+${manga.id}}"
                                           class="hover:text-[#eb3349] text-[14px] w-10/12"
                                        ></a>

                                        <div class="flex gap-[10px] items-center text-[12px] text-[#9e9e9e]">
                                            <ul>
                                                <i class="fas fa-star" th:style="${manga.getRating().intValue() >= 1 ? 'color: #ffeb3b;' : ''}"></i>
                                                <i class="fas fa-star" th:style="${manga.getRating().intValue() >= 2 ? 'color: #ffeb3b;' : ''}"></i>
                                                <i class="fas fa-star" th:style="${manga.getRating().intValue() >= 3 ? 'color: #ffeb3b;' : ''}"></i>
                                                <i class="fas fa-star" th:style="${manga.getRating().intValue() >= 4 ? 'color: #ffeb3b;' : ''}"></i>
                                                <i class="fas fa-star" th:style="${manga.getRating().intValue() >= 5 ? 'color: #ffeb3b;' : ''}"></i>
                                            </ul>


                                        </div>

                                    </h4>

                                    <div th:if="${typeStatus != 'coming'}">
                                        <!--  for display chapter by vol-->
                                        <ul th:if="${manga.volumeEntities.size() > 0 && volI.index < 1}"
                                            class="latest-chapters grid space-y-2 mt-[10px] gap-[5px] p-0"
                                            th:each="volume,volI : ${manga.volumeEntities}">
                                            <li th:each="chapter,iter: ${volume.chapterEntities}" th:if="${iter.index < 2}">

                                                <div class="gap-[5px] flex items-center">
                                                    <a th:href="@{'/manga/'+${manga.mangaName}+'/chapter/'+${chapter.id}}"
                                                       th:text="${'Chương ' + (chapter.chapterIndex + 1)}"
                                                       style="border: 1px solid #ebebeb"
                                                       class="block min-w-[80px] max-w-[120px] py-[2px] h-full text-center text-[12px] text-[#666666] hover:text-white hover:bg-[#eb3349] duration-300 ease-in rounded-[10px]">
                                                    </a>
                                                    <span class="text-[12px] text-[#666666]"
                                                          th:text="${'Tập ' + (volume.volumeIndex + 1)}">
                                        </span>
                                                </div>
                                                <span class="text-[10px] text-[#666666] text-center"  th:text="${#dates.format(chapter.createdAt, 'dd-MM-yyyy')}"></span>
                                            </li>
                                        </ul>
                                        <!--  for display chapter by chap -->
                                        <ul th:else class="latest-chapters grid mt-[10px] gap-[10px] p-0">
                                            <li class="gap-[5px] grid" th:each="chapter,iter: ${manga.chapters}"
                                                th:if="${iter.index < 2}"
                                            >
                                                <a th:href="@{'/manga/'+${manga.mangaName}+'/chapter/'+${chapter.id}}"
                                                   th:text="${'Chương ' + (chapter.chapterIndex + 1)}"
                                                   style="border: 1px solid #ebebeb"
                                                   class="block min-w-[80px] max-w-[120px] py-[2px] h-full text-center text-[12px] text-[#666666] hover:text-white hover:bg-[#eb3349] duration-300 ease-in rounded-[10px]">
                                                </a>
                                                <span class="text-[10px] text-[#666666] text-center"  th:text="${#dates.format(chapter.createdAt, 'dd-MM-yyyy')}"></span>
                                            </li>
                                        </ul>
                                    </div>

                                </div>
                            </a>

                            <div th:if="${typeStatus != 'coming'}" class="absolute w-fit h-fit top-[-14px] right-0">
                                <span th:if="${manga.isFree}"
                                  class="manga-title-badget inline-block bg-[#37b7da] w-[50px] h-[24px] rounded-full text-center text-[10px] text-white leading-[26px] font-bold rotate-[-10deg]">
                                    Miễn phí
                                </span>
                                <span th:if="${!manga.isFree}"
                                      class="manga-title-badget inline-block bg-[#eb3349] w-[40px] h-[24px] rounded-full text-center text-[10px] text-white leading-[26px] font-bold rotate-[-10deg]">
                                    Trả phí
                                </span>
                            </div>
                        </li>

                    </ul>


<!--                    <div th:if="${!mangalist.isEmpty()}" th:replace="fragments/page-component :: page-component" />-->

<!--                    Custom only page trangmanga-->
                    <div class="page_component mt-[20px]"
                         th:if="${!mangalist.isEmpty()}">
                        <div class="flex justify-center">
                            <nav aria-label="Page navigation example" th:if="${typeStatus}==''">
                                <ul class="list-style-none flex gap-x-[5px]">
                                    <li th:if="${hasPrevPage}"><a
                                            class="relative block rounded bg-transparent py-1.5 px-3 text-sm text-neutral-600 transition-all duration-300 hover:bg-neutral-100 dark:text-white dark:hover:bg-neutral-700 dark:hover:text-white"
                                            th:href="@{ '?page=' + ${currentPage-1} }" aria-label="Previous"> <span aria-hidden="true">&laquo;</span>
                                    </a></li>

                                    <li th:if="${totalPage == 0}">
                                        <a th:if="${currentPage == i}"
                                           class="relative border block rounded bg-[#03a9f4] py-1.5 px-3 text-sm text-white">
                                            1
                                        </a>
                                    </li>

                                    <li th:if="${totalPage > 0}" th:each="i : ${#numbers.sequence(0, totalPage-1)}">
                                        <a th:if="${currentPage == i}"
                                           class="relative border block rounded bg-[#03a9f4] py-1.5 px-3 text-sm text-white"
                                           th:text="${i + 1}">
                                        </a>

                                        <a th:if="${currentPage != i}"
                                           class="relative border block rounded bg-transparent py-1.5 px-3 text-sm text-neutral-600 transition-all duration-300 hover:bg-neutral-100 dark:text-white dark:hover:bg-neutral-700 dark:hover:text-white"
                                           th:href="${'?page='+i }" th:text="${i + 1}">
                                        </a>

                                    </li>


                                    <li th:if="${hasNextPage}"><a
                                            class="relative block rounded bg-transparent py-1.5 px-3 text-sm text-neutral-600 transition-all duration-300 hover:bg-neutral-100 dark:text-white dark:hover:bg-neutral-700 dark:hover:text-white"
                                            th:href="@{ '?page=' + ${currentPage+1} }" aria-label="Next"><span
                                            aria-hidden="true">&raquo;</span>
                                    </a></li>
                                </ul>
                            </nav>

                            <!-- if type not Empty -->
                            <nav aria-label="Page navigation example" th:if="${typeStatus} != '' ">
                                <ul class="list-style-none flex gap-x-[5px]">
                                    <li th:if="${hasPrevPage}"><a
                                            class="relative block rounded bg-transparent py-1.5 px-3 text-sm text-neutral-600 transition-all duration-300 hover:bg-neutral-100 dark:text-white dark:hover:bg-neutral-700 dark:hover:text-white"
                                            th:href="@{ '?page=' + ${currentPage-1} + '&type=' + ${typeStatus} }" aria-label="Previous"> <span aria-hidden="true">&laquo;</span>
                                    </a></li>

                                    <li th:if="${totalPage == 0}">
                                        <a th:if="${currentPage == i}"
                                           class="relative border block rounded bg-[#03a9f4] py-1.5 px-3 text-sm text-white">
                                            1
                                        </a>
                                    </li>

                                    <li th:if="${totalPage > 0}" th:each="i : ${#numbers.sequence(0, totalPage-1)}">
                                        <a th:if="${currentPage == i}"
                                           class="relative border block rounded bg-[#03a9f4] py-1.5 px-3 text-sm text-white"
                                           th:text="${i + 1}">
                                        </a>

                                        <a th:if="${currentPage != i}"
                                           class="relative border block rounded bg-transparent py-1.5 px-3 text-sm text-neutral-600 transition-all duration-300 hover:bg-neutral-100 dark:text-white dark:hover:bg-neutral-700 dark:hover:text-white"
                                           th:href="@{'?page='+${i} + '&type=' + ${typeStatus}}" th:text="${i + 1}">
                                        </a>

                                    </li>


                                    <li th:if="${hasNextPage}"><a
                                            class="relative block rounded bg-transparent py-1.5 px-3 text-sm text-neutral-600 transition-all duration-300 hover:bg-neutral-100 dark:text-white dark:hover:bg-neutral-700 dark:hover:text-white"
                                            th:href="@{ '?page=' + ${currentPage+1} + '&type=' + ${typeStatus}}" aria-label="Next"><span
                                            aria-hidden="true">&raquo;</span>
                                    </a></li>
                                </ul>
                            </nav>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        <div class="w-[300px] p-2">
            <!-- phần tử con bên phải -->
            <div class="flex justify-center">
                <div class="w-full p-2 ">
                    <div class="flex flex-col">
                        <div class="sidebar-section py-[10px] border px-[15px]" style="border: 1px solid #9e9e9e2e;">
                            <h3 class="sidebar-section_title text-xl font-bold bordered border-b-[2px] border-black pb-2 m-0 mb-[15px]">
                                Lịch sử đọc truyện
                            </h3>

                            <div id="card-list" class="card-container manga-history-sidebar grid space-y-2">
                            </div>
                            <!--sự kiện đọc lịch sử từ localstorage-->

                            <script th:inline="javascript">
                                    /*<![CDATA[*/
                                    document.addEventListener('DOMContentLoaded',function () {

                                        const logger = /*[[${logger}]]*/ 'default';
                                        if (typeof logger === "undefined" || logger === null) {
                                            // Đọc thông tin từ Local Storage
                                            const loggedUserJson = localStorage.getItem("users");
                                            const loggedUser = JSON.parse(loggedUserJson) || [];
                                            const cardList = document.getElementById('card-list');
                                            for (let i = 0; i < loggedUser.length; i++) {
                                                const user = loggedUser[i];
                                                const chapterId = user.chapterId;
                                                const mangaId = user.mangaId;

                                                fetch('http://localhost:8080/mangaTest/getManga/' + mangaId,{
                                                    method: 'GET'
                                                })
                                                    .then(res => {
                                                        if (!res.ok){
                                                            throw new Error('Network response was not ok');
                                                        }
                                                        return res.json();
                                                    })
                                                    .then(data => {

                                                        // Tạo thẻ card mới
                                                        const cardContainer = document.createElement('div');
                                                        cardContainer.setAttribute('class', 'card-container w-full flex gap-[10px] h-[90px]');
                                                        const cardImage = document.createElement('div');
                                                        cardImage.setAttribute('class', 'card-image w-[90px] h-full');
                                                        const img = document.createElement('img');
                                                        img.setAttribute('src', data.featuredImage);
                                                        img.setAttribute('class','w-full h-full');
                                                        cardImage.appendChild(img);
                                                        const cardText = document.createElement('div');
                                                        cardText.setAttribute('class', 'card-text ml-1');
                                                        const cardTitle = document.createElement('h2');
                                                        cardTitle.setAttribute('class', 'card-title text-sm m-0 w-[140px]');
                                                        cardTitle.innerHTML = data.title;

                                                        /*
                                                        const MAX_LENGTH = 14; // Tối đa chiều cao của thẻ card-title
                                                        if (data.title.length > MAX_LENGTH) {
                                                            // Nếu tiêu đề vượt quá giới hạn, cắt giảm chiều dài và thêm dấu ba chấm
                                                            cardTitle.innerHTML = data.title.slice(0, MAX_LENGTH) + '...';
                                                        } else {
                                                            cardTitle.innerHTML = data.title;
                                                        }
                                                        */
                                                        const cardLink  = document.createElement('a');
                                                        console.log(data.title + ' title ')
                                                        cardLink.setAttribute('class', 'card-link text-blue-500 hover:underline');
                                                        cardLink.setAttribute('href', 'http://localhost:8080/manga/' + data.title + '/chapter/' + chapterId);
                                                        cardLink.innerHTML = 'Đọc tiếp';

                                                        cardText.appendChild(cardTitle);
                                                        cardText.appendChild(cardLink);
                                                        cardContainer.appendChild(cardImage);
                                                        cardContainer.appendChild(cardText);
                                                        cardList.appendChild(cardContainer);
                                                    })
                                                    .catch(error => {
                                                        console.error('Error:', error);
                                                    });
                                            }
                                        }
                                    })
                                    /*]]>*/

                            </script>
                            <!--Kết thúc sự kiện đọc lịch sử từ localstorage-->
                        </div>
                        <div class="list-genre min-w-[200px] h-fit border p-[10px] mt-[15px] rounded">
                            <h3 class="border w-fit text-sm text-white font-medium rounded bg-[#eb3349] py-[5px] px-[10px]">
                                Thể loại</h3>

                            <ul class="grid grid-cols-2 gap-2 space-x-2 mt-[20px]">
                                <li class="flex items-center space-x-2" th:each="item : ${genreList}">
                                    <i class="fas fa-caret-right" style="color: #343537;"></i>
                                    <a class="cursor-pointer hover:text-[#eb3349]"
                                       th:href="@{'/genre/' + ${item.slug} + '/' + ${item.id}}"
                                       th:text="${item.name}"></a>
                                </li>
                            </ul>

                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

</body>
</html>